<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Monitor Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Telegram Mini App Theme Integration */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-theme-bg-color, #f4f4f5); /* Telegram BG Color */
            color: var(--tg-theme-text-color, #000000); /* Telegram Text Color */
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        input[type="text"], button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-sizing: border-box;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        .monitor-type-toggle {
            display: flex;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .monitor-type-toggle button {
            flex-grow: 1;
            background-color: transparent;
            color: var(--tg-theme-text-color);
            border: none;
            padding: 10px 0;
            cursor: pointer;
        }
        .monitor-type-toggle button.active {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: bold;
        }
        .list-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item .status {
            font-weight: bold;
            color: var(--tg-theme-link-color, #007bff);
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            width: auto;
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>Monitor Setup</h2>
        <input type="text" id="usernameInput" placeholder="Enter Instagram Username (@user)">
        
        <div class="monitor-type-toggle">
            <button id="banToggle" class="active" onclick="setMonitorType('BAN')">BAN Watch ðŸš«</button>
            <button id="unbanToggle" onclick="setMonitorType('UNBAN')">UNBAN Watch âœ…</button>
        </div>
        
        <p style="color: var(--tg-theme-hint-color);">Your Telegram User ID: <code id="userIdDisplay">Loading...</code></p>
    </div>

    <div class="card">
        <h2>Active Monitoring List</h2>
        <div id="monitoringList">Loading list...</div>
    </div>

    <script>
        let currentMonitorType = 'BAN';
        let telegramUserId = null;
        const PYTHON_API_URL = 'YOUR_PYTHON_SERVER_URL/api'; // Replace with your actual server URL (e.g., http://yourserver.com:8080/api)

        // 1. Initial Telegram Web App Setup
        if (window.Telegram && window.Telegram.WebApp) {
            const WebApp = window.Telegram.WebApp;
            WebApp.ready();
            WebApp.expand();
            
            // Apply Telegram Theme
            document.documentElement.style.setProperty('--tg-theme-bg-color', WebApp.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', WebApp.themeParams.secondary_bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', WebApp.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-hint-color', WebApp.themeParams.hint_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', WebApp.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', WebApp.themeParams.button_text_color);

            // Get User ID (Crucial for linking to your Python Script)
            if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                telegramUserId = WebApp.initDataUnsafe.user.id;
                document.getElementById('userIdDisplay').textContent = telegramUserId;
                loadMonitoringList();
            } else {
                document.getElementById('userIdDisplay').textContent = 'ERROR: User ID not found.';
            }


            // 2. Main Button Control
            WebApp.MainButton.setText('START MONITORING');
            WebApp.MainButton.setParams({
                color: WebApp.themeParams.button_color,
                text_color: WebApp.themeParams.button_text_color
            });
            WebApp.MainButton.show();
            WebApp.MainButton.onClick(handleStartMonitoring);

        }

        function setMonitorType(type) {
            currentMonitorType = type;
            document.getElementById('banToggle').classList.remove('active');
            document.getElementById('unbanToggle').classList.remove('active');
            document.getElementById(type.toLowerCase() + 'Toggle').classList.add('active');
            WebApp.MainButton.setText(type === 'BAN' ? 'START BAN MONITORING ðŸš«' : 'START UNBAN MONITORING âœ…');
        }

        async function handleStartMonitoring() {
            const username = document.getElementById('usernameInput').value.trim().replace('@', '');
            if (!username) {
                WebApp.showAlert('Please enter an Instagram username.');
                return;
            }
            if (!telegramUserId) {
                WebApp.showAlert('Error: Could not retrieve Telegram User ID.');
                return;
            }
            
            WebApp.MainButton.showProgress(true);

            // 3. API Call to your Python Backend
            try {
                const response = await fetch(`${PYTHON_API_URL}/add_monitor`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: telegramUserId,
                        username: username,
                        monitor_type: currentMonitorType,
                        // Note: WebApp.initData (mini app authorization data) should be sent securely in a real app
                        init_data: window.Telegram.WebApp.initData 
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    WebApp.showAlert(`Monitoring for @${username} started as ${currentMonitorType}!`);
                    document.getElementById('usernameInput').value = '';
                    loadMonitoringList(); // Reload list after adding
                } else {
                    WebApp.showAlert(`Error: ${data.message || 'Failed to start monitoring.'}`);
                }

            } catch (error) {
                console.error('API Error:', error);
                WebApp.showAlert('Network Error: Could not reach the monitoring server.');
            } finally {
                WebApp.MainButton.hideProgress();
            }
        }
        
        async function loadMonitoringList() {
             if (!telegramUserId) return;

             const listContainer = document.getElementById('monitoringList');
             listContainer.innerHTML = 'Fetching list...';

             try {
                const response = await fetch(`${PYTHON_API_URL}/get_list/${telegramUserId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = '';
                    
                    const all_users = [
                        ...data.ban_list.map(u => ({ username: u, type: 'BAN' })),
                        ...data.unban_list.map(u => ({ username: u, type: 'UNBAN' }))
                    ];
                    
                    if (all_users.length === 0) {
                        listContainer.innerHTML = '<p style="text-align: center;">Your list is empty.</p>';
                        return;
                    }

                    all_users.forEach(user => {
                        const statusColor = user.type === 'BAN' ? 'var(--tg-theme-destructive-text-color, #dc3545)' : 'var(--tg-theme-button-color, #28a745)';
                        const statusText = user.type === 'BAN' ? 'ðŸš« BAN' : 'âœ… UNBAN';
                        
                        html += `
                            <div class="list-item">
                                <div>
                                    @${user.username} 
                                    <span class="status" style="color: ${statusColor};">${statusText}</span>
                                </div>
                                <button class="stop-btn" onclick="handleStopMonitoring('${user.username}')">Stop</button>
                            </div>
                        `;
                    });
                    listContainer.innerHTML = html;
                    
                } else {
                    listContainer.innerHTML = `<p style="color: red;">Error loading list: ${data.message}</p>`;
                }

            } catch (error) {
                listContainer.innerHTML = '<p style="color: red;">Failed to connect to monitoring API.</p>';
            }
        }
        
        // Note: handleStopMonitoring function requires a separate API endpoint in Python backend
        async function handleStopMonitoring(username) {
            if (!confirm(`Are you sure you want to stop monitoring @${username}?`)) return;

            // **TODO:** Create a /api/stop_monitor endpoint in your Python script 
            // and call it here. After the call, call loadMonitoringList().
            
            WebApp.showAlert(`Stopping monitoring for @${username}... (Requires Python API setup)`);
            
            // Example Placeholder Logic:
            try {
                // Assuming you create a DELETE endpoint
                const response = await fetch(`${PYTHON_API_URL}/stop_monitor`, {
                    method: 'POST', // Use POST or DELETE based on your Flask/FastAPI setup
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: telegramUserId, username: username })
                });

                if (response.ok) {
                    WebApp.showPopup({message: `Monitoring for @${username} stopped.`});
                    loadMonitoringList();
                } else {
                     WebApp.showAlert(`Failed to stop monitoring for @${username}.`);
                }
            } catch (e) {
                WebApp.showAlert('Error stopping monitor on server.');
            }
        }


    </script>
</body>
</html>
